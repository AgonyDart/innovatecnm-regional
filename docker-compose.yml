version: "0.1"

services:
  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2.0
    restart: always
    ports:
      - "${MQTT_PORT}:${MQTT_PORT}" # standard MQTT
      - "${MQTT_WS_PORT}:${MQTT_WS_PORT}" # WebSocket
    volumes:
      - /mosquitto/config:/mosquitto/config
      - /mosquitto/data:/mosquitto/data
      - /mosquitto/log:/mosquitto/log

  # Database
  db:
    image: postgres:16
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data

    # Backend (FastAPI + Data Ingestion & AI)
    backend:
      build: ./backend
      restart: always
      depends_on:
        - mosquitto
        - db
      environment:
        - MQTT_BROKER_HOST=mosquitto
        - MQTT_BROKER_PORT=${MQTT_PORT}
        - DB_HOST=db
        - DB_USER=${POSTGRES_USER}
        - DB_PASSWORD=${POSTGRES_PASSWORD}
        - DB_NAME=${POSTGRES_DB}
      ports:
        - "${BACKEND_PORT}:${BACKEND_PORT}"

    # Frontend (NextJs)
  frontend:
    build: ./frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "${FRONTEND_PORT}:${FRONTEND_PORT}"
    environment:
      - NEXT_PUBLIC_BACKEND_URL=http://backend:${BACKEND_PORT}

volumes:
  postgres_data:
